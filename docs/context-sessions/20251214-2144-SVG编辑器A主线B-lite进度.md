# Session: SVG 编辑器进度（A 主线 + B-lite）

## 元信息

- **创建时间**: 2025-12-14 21:44
- **状态**: 进行中
- **项目路径**: D:\vscode_workspace\svg_project

## 上下文摘要

当前项目已经从“直接操作 DOM 的 demo”升级为 **model-driven 的 SVG 编辑器内核**：Document 作为唯一真相，render 纯渲染输出，interaction 只触发命令。A 路线（资产库/导入/导出）已跑通一条可用闭环，同时为后续 B-lite（布局/变换/对齐等）留了清晰扩展点。

## 已完成任务

- [x] **架构分层**：`src/model` + `src/render` + `src/interaction`，主流程在 `src/main.js`
- [x] **基础编辑**：新增 rect/circle/text；选中/拖拽移动；空格拖拽平移；滚轮缩放画布
- [x] **选中缩放**：`Shift + 滚轮` 缩放选中元素（rect/circle/text/use）
- [x] **属性面板**：位置、fill/stroke/strokeWidth/opacity、文字内容、文字字号（仅 text）
- [x] **资产库（A 核心）**：
  - 批量导入 SVG → 清洗/内联 style/隔离 id&class → 存为 Asset
  - 点击资产 → 画布空白单击放置 `<use>`
  - 搜索/重命名/从资产库移除/清空资产库
- [x] **资产库与画布解耦**：
  - 左侧删除/清空资产库 **不会删除画布实例**
  - 对“仍被画布引用”的资产：标记为 `archived` 隐藏，但保留 defs 以保证实例还能显示
  - 当 archived 资产不再被任何实例引用时自动清理（GC）
- [x] **导出**：
  - “导出 SVG”：导出当前画布（包含 defs/symbol/use）
  - “导出 Sprite”：导出资产库 sprite（只包含 symbol 定义，浏览器打开空白是正常现象）
- [x] **撤销/重做**：`Ctrl+Z` 撤销、`Ctrl+Y` 重做（兼容 `Ctrl+Shift+Z`）；拖拽移动只记录一次历史快照
- [x] **启动体验**：初始画布为空（不再自动塞示例图形）

## 未完成任务

- ?? **高优先级（体验/稳定）**
  - 撤销/重做“合并策略”：输入框改值不该一敲一个历史点（建议：实时预览 + onBlur/停顿合并入栈）
  - 明确导出策略：Sprite 是否需要“预览版导出”（带一排 `<use>` 方便肉眼检查）
- ?? **高优先级（A 交付增强）**
  - `currentColor` 规范化：对 fill/stroke 做“仅纯色替换”的批处理（避免渐变/复杂多色被毁）
  - 资产导出扩展：批量导出单个 SVG、sprite + manifest（id/name/fileName 映射）
- ?? **中优先级（B-lite 基座）**
  - 统一变换模型：scale/rotate 用统一 transform/matrix，而不是按类型改 width/height/r/fontSize
  - 多选/框选 + 对齐/分布 + 网格/吸附
  - 图层/顺序（上移/下移/锁定/隐藏）与分组

## 关键文件

| 文件路径 | 说明 |
|---------|------|
| `index.html` | 三栏 UI：资产库/画布/属性；快捷键提示；新增 Sprite/资产库操作按钮 |
| `src/styles.css` | 三栏布局与资产列表样式（按钮 disabled 态也在这里） |
| `src/main.js` | 主逻辑：Document 状态、渲染绑定、交互、历史栈、资产库 UI、导出 |
| `src/model/document.js` | Document 初始结构 |
| `src/model/factories.js` | Node/Asset 工厂（Asset 增加 `archived` 字段） |
| `src/model/commands.js` | 命令：增删改、缩放选中、资产 rename/archive/delete、GC 等 |
| `src/interaction/svgImport.js` | SVG 导入：解析 + 清洗 + style 内联 + id/class 隔离 |
| `src/render/render.js` | 渲染：defs(symbol id=assetId) + use(href=#assetId) + scene |
| `src/render/serialize.js` | 序列化导出：画布 SVG + 资产 sprite |

## 技术细节

- **Sprite 是什么**：一个“symbol 库文件”，只定义 `<symbol>` 不直接显示；使用时用 `<use href="sprite.svg#symbolId">` 引用。
- **资产库与画布解耦实现**：对被实例引用的资产用 `archived=true` 隐藏，实例仍显示；实例删光后通过 `purgeUnusedArchivedAssets()` 自动回收资产。
- **历史栈策略**：selection/viewBox（平移/缩放）默认不入栈，避免撤销序列被交互噪声污染；拖拽移动只在首次移动时记录一次快照。

## 注意事项

- 当前环境 Git Bash 的 `bash` 会报权限错误，执行命令建议用 PowerShell。
- SVG 导入清洗是 MVP 取舍：复杂 CSS/滤镜/外链资源可能被删除或降级，保证“导入不炸、不会带脚本”优先。

## 下一步行动

1. 优先做撤销合并：对 `input` 类操作实现节流/事务（`src/main.js` 的 `commit/history` 一把梭）
2. 落地 A 的“可交付增强”：`currentColor` 批处理 + sprite manifest 导出
3. 开始 B-lite 基座：统一 transform（scale/rotate）→ 再做手柄缩放/旋转、多选/框选、对齐吸附

---
*此存档由 context-save Skill 自动生成*

