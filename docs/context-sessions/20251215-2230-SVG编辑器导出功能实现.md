# Session: SVG ç¼–è¾‘å™¨å¯¼å‡ºåŠŸèƒ½å®ç°

## å…ƒä¿¡æ¯

- **åˆ›å»ºæ—¶é—´**: 2025-12-15 22:30
- **çŠ¶æ€**: è¿›è¡Œä¸­
- **é¡¹ç›®è·¯å¾„**: D:\vscode_workspace\svg_project

## ä¸Šä¸‹æ–‡æ‘˜è¦

é¡¹ç›®ä¿æŒ **model-driven** æ¶æ„ï¼š`model` ç®¡æ•°æ®ä¸å‘½ä»¤ã€`render` çº¯æ¸²æŸ“/åºåˆ—åŒ–ã€`interaction` æ”¾ SVG è§£æ/å¯¼å…¥/å¤„ç†å·¥å…·ã€‚æœ¬æ¬¡ä¼šè¯ä»å­˜æ¡£æ¢å¤åï¼Œå®Œæˆäº†"å¯¼å‡ºäº¤ä»˜ä»¶"åŠŸèƒ½çš„è®¾è®¡ä¸å®ç°ï¼Œæ–°å¢äº†èµ„äº§åŒ…å¯¼å‡ºï¼ˆsprite + manifestï¼‰å’Œå•èµ„äº§ SVG å¯¼å‡ºä¸¤ä¸ªåŠŸèƒ½ã€‚

## å·²å®Œæˆä»»åŠ¡

- [x] **ä»å­˜æ¡£æ¢å¤ä¸Šä¸‹æ–‡**ï¼šè¯»å– `20251215-2125-SVGç¼–è¾‘å™¨è¿›åº¦-å¤šé€‰ä¸currentColorä¸å¯¼å‡ºè§„åˆ’.md`
- [x] **å¯¼å‡ºåŠŸèƒ½è®¾è®¡**ï¼šç¡®å®šäº† serialize å±‚çº¯å‡½æ•° + main.js UI äº¤äº’çš„åˆ†å±‚æ–¹æ¡ˆ
- [x] **serialize.js æ–°å¢ä¸¤ä¸ªçº¯å‡½æ•°**ï¼š
  - `serializeAssetsToManifest(assetsById)` - è¿”å› manifest å¯¹è±¡ï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè°ƒç”¨æ–¹è‡ªå·± JSON.stringifyï¼‰
  - `serializeSingleAssetToSvgString(asset)` - å•èµ„äº§åºåˆ—åŒ–ä¸ºå®Œæ•´ SVG å­—ç¬¦ä¸²
- [x] **index.html æ–°å¢ä¸¤ä¸ªæŒ‰é’®**ï¼š
  - "å¯¼å‡ºèµ„äº§åŒ…" (`btnExportAssetPack`) - å¸¦ title æç¤º
  - "å¯¼å‡ºé€‰ä¸­èµ„äº§" (`btnExportSingleAsset`) - å¸¦ title æç¤º
- [x] **main.js å®Œæ•´å®ç°**ï¼š
  - å¯¼å…¥æ–°çš„åºåˆ—åŒ–å‡½æ•°
  - è·å–æŒ‰é’® DOM å¼•ç”¨
  - `downloadAssetPack()` å‡½æ•° - ä¸€é”®ä¸‹è½½ sprite.svg + manifest.jsonï¼ˆåŒæ—¶é—´æˆ³ï¼‰
  - `downloadSingleAsset()` å‡½æ•° - ä¸‹è½½å½“å‰é€‰ä¸­èµ„äº§ä¸ºå•ç‹¬ SVG
  - äº‹ä»¶ç›‘å¬ç»‘å®š
  - `syncPlacementInfo()` ä¸­æ›´æ–°æŒ‰é’® disabled çŠ¶æ€
- [x] **ä»£ç è¯­æ³•æ£€æŸ¥**ï¼š`node --check` éªŒè¯ serialize.js å’Œ main.js è¯­æ³•æ­£ç¡®

## æœªå®Œæˆä»»åŠ¡

- ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**: å®é™…æµ‹è¯•éªŒè¯å¯¼å‡ºåŠŸèƒ½ï¼ˆéœ€è¦åœ¨æµè§ˆå™¨é‡Œå¯¼å…¥ SVG åæµ‹è¯•æŒ‰é’®ï¼‰
- ğŸŸ¢ **ä½ä¼˜å…ˆçº§**: ï¼ˆå¯é€‰ï¼‰Sprite é¢„è§ˆç‰ˆå¯¼å‡º - ç”Ÿæˆ `sprite-preview.svg`ï¼Œè‡ªåŠ¨æ’åˆ— `<use>` åšè‚‰çœ¼éªŒè´§

## å…³é”®æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `src/render/serialize.js` | åºåˆ—åŒ–å±‚ï¼Œæ–°å¢ `serializeAssetsToManifest` å’Œ `serializeSingleAssetToSvgString` ä¸¤ä¸ªçº¯å‡½æ•° |
| `src/main.js` | ä¸»é€»è¾‘ï¼Œæ–°å¢ `downloadAssetPack` å’Œ `downloadSingleAsset` ä¸¤ä¸ªä¸‹è½½å‡½æ•°ï¼Œä»¥åŠäº‹ä»¶ç›‘å¬å’ŒæŒ‰é’®çŠ¶æ€ç®¡ç† |
| `index.html` | UI å±‚ï¼Œåœ¨èµ„äº§åº“åŒºåŸŸ `.asset-controls` æ–°å¢ä¸¤ä¸ªå¯¼å‡ºæŒ‰é’® |

## æŠ€æœ¯ç»†èŠ‚

### manifest.json ç»“æ„
```json
{
  "version": "1.0",
  "generatedAt": "2025-12-15T14:30:00.000Z",
  "assets": [
    {
      "id": "asset_xxx",
      "name": "icon-home",
      "viewBox": "0 0 24 24",
      "sourceFileName": "home.svg"
    }
  ]
}
```

### æ–°å¢å‡½æ•°ç­¾å

**serialize.js**:
```js
// è¿”å› manifest å¯¹è±¡ï¼Œè°ƒç”¨æ–¹è‡ªå·± JSON.stringify
export function serializeAssetsToManifest(assetsById) â†’ { version, generatedAt, assets: [] }

// è¿”å›å®Œæ•´ SVG å­—ç¬¦ä¸²ï¼ˆå¸¦ xml å£°æ˜ï¼‰
export function serializeSingleAssetToSvgString(asset) â†’ string
```

**main.js**:
```js
// ä¸€é”®ä¸‹è½½ sprite-{timestamp}.svg + manifest-{timestamp}.json
function downloadAssetPack()

// ä¸‹è½½ {èµ„äº§å}.svgï¼ˆæ–‡ä»¶åè¿‡æ»¤éæ³•å­—ç¬¦ï¼‰
function downloadSingleAsset()
```

### æŒ‰é’®çŠ¶æ€é€»è¾‘

| æŒ‰é’® | å¯ç”¨æ¡ä»¶ |
|------|---------|
| `btnExportAssetPack` | `libraryCount > 0`ï¼ˆèµ„äº§åº“éç©ºï¼‰ |
| `btnExportSingleAsset` | `canManageActive`ï¼ˆæœ‰é€‰ä¸­ä¸”æœªå½’æ¡£çš„èµ„äº§ï¼‰ |

### æ–‡ä»¶åè§„åˆ™

- èµ„äº§åŒ…ï¼š`sprite-{ISOæ—¶é—´æˆ³}.svg` + `manifest-{ISOæ—¶é—´æˆ³}.json`ï¼ˆç›¸åŒæ—¶é—´æˆ³æ–¹ä¾¿é…å¯¹ï¼‰
- å•èµ„äº§ï¼š`{èµ„äº§å}.svg`ï¼ˆåç§°ä¸­çš„ `\ / : * ? " < > |` æ›¿æ¢ä¸º `_`ï¼‰

## æ³¨æ„äº‹é¡¹

- å½“å‰ç¯å¢ƒ Git Bash çš„ `bash` ä¼šæŠ¥æƒé™é”™è¯¯ï¼Œæ‰§è¡Œå‘½ä»¤å»ºè®®ç”¨ PowerShell æˆ–ç”¨ sed/node è„šæœ¬
- VSCode è‡ªåŠ¨ä¿å­˜ä¼šå¯¼è‡´ Edit å·¥å…·é¢‘ç¹æŠ¥ "File has been unexpectedly modified"ï¼Œç”¨ sed æˆ– bash heredoc æ›´ç¨³å®š
- èµ„äº§åŒ…å¯¼å‡ºä¼šè§¦å‘ä¸¤æ¬¡ä¸‹è½½ï¼ˆsprite + manifestï¼‰ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šå¼¹ä¸¤æ¬¡ä¿å­˜å¯¹è¯æ¡†ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸º
- `serializeAssetsToManifest` è¿”å›çš„æ˜¯å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™æ˜¯æœ‰æ„è®¾è®¡ï¼Œæ–¹ä¾¿è°ƒç”¨æ–¹æ§åˆ¶ JSON æ ¼å¼åŒ–ï¼ˆç¼©è¿›ç­‰ï¼‰

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æµ‹è¯•éªŒè¯**ï¼šåœ¨æµè§ˆå™¨æ‰“å¼€ `index.html`ï¼Œå¯¼å…¥å‡ ä¸ª SVG èµ„äº§ï¼Œæµ‹è¯•ï¼š
   - "å¯¼å‡ºèµ„äº§åŒ…" æŒ‰é’®æ˜¯å¦æ­£å¸¸è§¦å‘ä¸¤æ¬¡ä¸‹è½½
   - "å¯¼å‡ºé€‰ä¸­èµ„äº§" æŒ‰é’®æ˜¯å¦æ­£å¸¸ä¸‹è½½é€‰ä¸­èµ„äº§
   - æŒ‰é’® disabled çŠ¶æ€æ˜¯å¦æ­£ç¡®ï¼ˆç©ºèµ„äº§åº“æ—¶ç¦ç”¨ã€æ— é€‰ä¸­æ—¶ç¦ç”¨ï¼‰
   - ä¸‹è½½çš„æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®

2. **ï¼ˆå¯é€‰ï¼‰å®ç° Sprite é¢„è§ˆç‰ˆ**ï¼š
   - åœ¨ `serialize.js` æ–°å¢ `serializeAssetsToSpritePreview(assetsById)`
   - ç”Ÿæˆä¸€ä¸ªå¸¦ `<use>` å®ä¾‹çš„ SVGï¼Œæ–¹ä¾¿è‚‰çœ¼æ£€æŸ¥æ‰€æœ‰èµ„äº§

3. **ï¼ˆå¯é€‰ï¼‰ä¼˜åŒ– UI**ï¼š
   - è€ƒè™‘æŠŠå¤šä¸ªå¯¼å‡ºæŒ‰é’®åˆå¹¶æˆä¸‹æ‹‰èœå•ï¼Œå‡å°‘æŒ‰é’®æ•°é‡

---

## æœ¬æ¬¡ä¼šè¯ä»£ç å˜æ›´æ‘˜è¦

### serialize.js æ–°å¢ä»£ç ï¼ˆç¬¬ 38-76 è¡Œï¼‰

```js
export function serializeAssetsToManifest(assetsById) {
  const assets = Object.values(assetsById ?? {})
    .filter((a) => a && !a.archived)
    .map((asset) => ({
      id: asset.id,
      name: asset.name ?? asset.id,
      viewBox: asset.viewBox ?? "",
      sourceFileName: asset.meta?.sourceFileName ?? ""
    }));

  return {
    version: "1.0",
    generatedAt: new Date().toISOString(),
    assets
  };
}

export function serializeSingleAssetToSvgString(asset) {
  if (!asset) return "";
  const root = svgEl("svg", {
    xmlns: "http://www.w3.org/2000/svg",
    "xmlns:xlink": "http://www.w3.org/1999/xlink",
    viewBox: asset.viewBox ?? "0 0 100 100"
  });
  root.innerHTML = asset.innerMarkup ?? "";
  const xml = new XMLSerializer().serializeToString(root);
  return `<?xml version="1.0" encoding="UTF-8"?>\n${xml}\n`;
}
```

### main.js å…³é”®å˜æ›´

1. **å¯¼å…¥**ï¼ˆç¬¬ 27 è¡Œï¼‰ï¼š
```js
import { serializeAssetsToSpriteString, serializeAssetsToManifest, serializeSingleAssetToSvgString, serializeDocumentToSvgString } from "./render/serialize.js";
```

2. **DOM å¼•ç”¨**ï¼ˆç¬¬ 47-48 è¡Œï¼‰ï¼š
```js
const btnExportAssetPack = document.getElementById("btnExportAssetPack");
const btnExportSingleAsset = document.getElementById("btnExportSingleAsset");
```

3. **ä¸‹è½½å‡½æ•°**ï¼ˆç¬¬ 251-326 è¡Œï¼‰ï¼š`downloadAssetPack()` å’Œ `downloadSingleAsset()`

4. **æŒ‰é’®çŠ¶æ€**ï¼ˆç¬¬ 585-586 è¡Œï¼‰ï¼š
```js
if (btnExportAssetPack) btnExportAssetPack.disabled = libraryCount === 0;
if (btnExportSingleAsset) btnExportSingleAsset.disabled = !canManageActive;
```

5. **äº‹ä»¶ç›‘å¬**ï¼ˆç¬¬ 860-861 è¡Œï¼‰ï¼š
```js
btnExportAssetPack?.addEventListener("click", downloadAssetPack);
btnExportSingleAsset?.addEventListener("click", downloadSingleAsset);
```

### index.html æ–°å¢æŒ‰é’®ï¼ˆ`.asset-controls` åŒºåŸŸï¼‰

```html
<button class="btn" id="btnExportAssetPack" type="button"
  title="ä¸€é”®ä¸‹è½½èµ„äº§åŒ…ï¼šsprite.svg + manifest.jsonï¼ˆä¸¤ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åå¸¦ç›¸åŒæ—¶é—´æˆ³æ–¹ä¾¿é…å¯¹ï¼‰">
  å¯¼å‡ºèµ„äº§åŒ…
</button>
<button class="btn" id="btnExportSingleAsset" type="button"
  title="æŠŠå½“å‰é€‰ä¸­çš„èµ„äº§å¯¼å‡ºä¸ºå•ç‹¬çš„ SVG æ–‡ä»¶ï¼ˆæ–¹ä¾¿å‘ç»™è®¾è®¡å¸ˆæˆ–è½ç›˜åˆ°å…¶ä»–ä»“åº“ï¼‰">
  å¯¼å‡ºé€‰ä¸­èµ„äº§
</button>
```

---
*æ­¤å­˜æ¡£ç”± context-save Skill è‡ªåŠ¨ç”Ÿæˆ*
