# Session: SVG 在线编辑器 MVP 核心

## 元信息

- **创建时间**: 2025-12-14 20:31
- **状态**: 进行中
- **项目路径**: D:\vscode_workspace

## 上下文摘要

将 `svg_project` 从“直接操作 DOM 的小骨架”重构为 model-driven 的 SVG 编辑器内核：Document 作为真相来源，render 负责输出 SVG DOM，interaction 只产生命令。完成资产库导入/放置、基础编辑交互、导出，以及撤销/重做等 MVP 能力。

## 已完成任务

- [x] 模块拆分：`model/`（数据+命令）、`render/`（渲染/序列化）、`interaction/`（视口/导入）
- [x] 画布基础交互：选中、拖拽移动、空格拖拽平移、滚轮缩放画布
- [x] 选中元素缩放：`Shift + 滚轮` 缩放选中元素（rect/circle/text/use）
- [x] 属性面板：位置、填充/描边/描边宽/透明度、文字内容、文字大小（仅文字）
- [x] 资产库：批量导入 SVG → 清洗/命名空间 → `<defs><symbol/></defs>`，画布用 `<use>` 放置
- [x] 导出 SVG：从 Document 序列化（包含 defs/symbol/use）
- [x] 初始加载画布空白（不再自动塞示例矩形/圆/文字）
- [x] 撤销/重做：`Ctrl+Z` 撤销，`Ctrl+Y` 重做（兼容 `Ctrl+Shift+Z`）

## 未完成任务

- ?? **高优先级**: 撤销/重做体验完善（例如对输入框连续修改做合并、可选纳入 viewBox/selection）
- ?? **中优先级**: 资产实例/基础图形的“统一变换”能力（scale/rotate 等），让 resize 不只靠改 width/height/r/fontSize
- ?? **中优先级**: 多选/框选（当前 selection 逻辑偏单选）
- ?? **低优先级**: 资产“平铺预览”按钮、`currentColor` 规范化按钮（来自 `svg_project/IDEA.md`）

## 关键文件

| 文件路径 | 说明 |
|---------|------|
| `svg_project/index.html` | 三栏 UI（资产库/画布/属性），快捷键提示 |
| `svg_project/src/styles.css` | 资产库面板与整体布局样式 |
| `svg_project/src/main.js` | 应用主逻辑：Document 状态、渲染、交互绑定、历史栈、快捷键 |
| `svg_project/src/model/document.js` | Document 初始结构（viewBox/settings/assets/nodes/selection） |
| `svg_project/src/model/factories.js` | Node/Asset 工厂（rect/circle/text/use） |
| `svg_project/src/model/commands.js` | 不可变命令（增删改/缩放选中/重置/资产 upsert 等） |
| `svg_project/src/render/render.js` | `renderAssetsToDefs` + `renderSceneNodes` 渲染输出 |
| `svg_project/src/render/serialize.js` | `serializeDocumentToSvgString` 导出 SVG 字符串 |
| `svg_project/src/interaction/svgImport.js` | SVG 导入解析+清洗+命名空间处理 |
| `svg_project/README.md` | 运行/操作说明（包含 Shift+滚轮、Ctrl+Z/Y） |

## 技术细节

- **核心数据结构**：Document `{ viewBox, settings, assets, nodes, selection }`，其中 assets 用 `<symbol>` 存一份，画布实例用 `<use>`。
- **渲染原则**：DOM 不再被“直接改”；每次 commit 更新 Document 后统一 render。
- **导入清洗（MVP）**：
  - 移除 `<script>/<foreignObject>` 等危险标签与 `on*` 事件属性
  - 去外链 href（http/https/javascript）
  - `<style>` 尽量内联为元素 style（仅支持简单选择器：tag、`.class`、`*`），然后删除 `<style>`
  - id/class 做前缀隔离，减少多个资产互相污染
- **撤销/重做**：
  - past/future 两个栈
  - 选择变化、viewBox（平移/缩放）不进历史（避免污染撤销序列）
  - 拖拽移动在首次 pointermove 时只记录一次快照，防止“一次拖拽产生 N 步”

## 注意事项

- 当前环境里 Git Bash 的 `bash` 进程会报权限错误，命令执行建议直接用 PowerShell。
- 复杂 SVG（大量 CSS 选择器/外部资源）导入后可能丢视觉效果：目前只做 MVP 级内联与安全清洗。
- 选中缩放目前按“改尺寸参数”实现（rect w/h，circle r，text fontSize，use w/h），后续如要统一 scale/rotate 建议上 transform 矩阵模型。

## 下一步行动

1. 先读 `svg_project/src/main.js`，重点看 `commit()` / `history` / `wheel` / `keydown` 的策略。
2. 决定撤销范围：是否把 `viewBox` 也纳入可撤销（可能需要开关/合并策略）。
3. 给属性面板输入做“合并提交”（例如 onBlur 入历史、输入过程中只更新但不入栈）。
4. 设计统一变换：在 Node 上引入 scale/rotate（或 matrix），并补齐 UI（缩放/旋转）与导出。

---
*此存档由 context-save Skill 自动生成*

