# Session: SVG 产品路线确定（A 主线 + B-lite 扩展）

## 元信息

- **创建时间**: 2025-12-14 20:55
- **状态**: 进行中
- **项目路径**: D:\vscode_workspace

## 上下文摘要

当前 `svg_project` 已具备可用的“资产库 + 画布拼装器”MVP：批量导入 SVG（清洗/隔离）→ 放置为 `<symbol>/<use>` 实例 → 选中/移动/缩放/改样式/改文字 → 导出。接下来路线确定：**务必把 A（资产流水线/导出）做成可交付主线**，同时逐步补 **B-lite（布局/变换/对齐等轻量编辑能力）**，暂不碰 B-hard（path 节点级编辑）。

## 已完成任务

- [x] 架构拆分：`model/`（数据+命令）、`render/`（渲染/序列化）、`interaction/`（视口/导入）
- [x] 资产库：批量导入 SVG → 安全清洗 → 命名空间隔离 → `<defs><symbol/></defs>` 渲染
- [x] 放置资产：点选资产 → 画布空白单击放置 `<use>` 实例（按 `placementSize` 适配）
- [x] 基础图形：矩形/圆/文字新增；文字支持单独字号输入
- [x] 交互：选中、拖拽移动、空格拖拽平移、滚轮缩放画布、`Shift+滚轮` 缩放选中元素
- [x] 导出：从 Document 序列化生成 SVG（包含 defs/symbol/use）
- [x] 初始画布空白（不再自动塞示例图形）
- [x] 撤销/重做：`Ctrl+Z` 撤销、`Ctrl+Y` 重做（兼容 `Ctrl+Shift+Z`）；拖拽移动只记录一次历史快照
- [x] UI 提示与 README 更新：快捷键/手势写明

## 未完成任务

- ?? **高优先级**: A 主线交付件（资产流水线）
  - 资产管理：重命名/删除/搜索/分组（至少 rename + delete）
  - 批量规范化：`currentColor`（建议提供“仅纯色替换”策略），统一 viewBox/尺寸策略明确化
  - 导出形态：sprite（symbol 集合）/ 批量单个 SVG / 当前画布合成导出（至少先做 sprite）
- ?? **高优先级**: 撤销/重做体验完善
  - 输入框修改目前会“按输入事件”入栈（文字每个字符都一条），需要合并策略（onBlur/节流/事务）
  - 是否把 viewBox（平移/缩放）纳入可撤销需要定规则（建议默认不纳入，提供开关）
- ?? **中优先级**: B-lite 基础能力（不要上来做 B-hard）
  - 统一变换模型：支持 scale/rotate（最好升级为矩阵或完整 transform），避免现在按类型改尺寸的分裂实现
  - 多选/框选 + 对齐/分布 + 网格/吸附
  - 图层/顺序（上移/下移/锁定/隐藏）与分组
- ?? **低优先级**: 更高阶 SVG 覆盖
  - 更完整的导入兼容（复杂 CSS 选择器、渐变/滤镜/clipPath/mask 等边界情况）
  - 动画方向（C）暂不做，等 A 交付与 B-lite 稳定后再评估

## 关键文件

| 文件路径 | 说明 |
|---------|------|
| `svg_project/src/main.js` | 主应用：Document 状态、渲染、交互绑定、历史栈、快捷键 |
| `svg_project/src/model/document.js` | Document 结构（viewBox/settings/assets/nodes/selection） |
| `svg_project/src/model/commands.js` | 命令：增删改、缩放选中 `scaleSelectedNodes`、reset、upsertAssets 等 |
| `svg_project/src/model/factories.js` | Node/Asset 工厂（rect/circle/text/use） |
| `svg_project/src/render/render.js` | 渲染：defs(symbol) + scene(nodes) |
| `svg_project/src/render/serialize.js` | 导出：Document → SVG 字符串 |
| `svg_project/src/interaction/svgImport.js` | 导入：解析/清洗/内联 style/命名空间隔离 |
| `svg_project/index.html` | 三栏 UI + 手势/快捷键提示 |
| `svg_project/src/styles.css` | 三栏布局与资产库样式 |
| `svg_project/README.md` | 运行/操作说明（含 Shift+滚轮、Ctrl+Z/Y） |

## 技术细节

- **A 资产策略**：每个导入 SVG 存为 `Asset`（viewBox + innerMarkup），渲染到 `<symbol id="asset-xxx">`；画布实例用 `<use href="#asset-xxx">`，实例只存位置/样式/尺寸。
- **安全清洗（MVP）**：去脚本/foreignObject/on*；去外链 href；`<style>` 尝试内联为元素 style 后删除；id/class 前缀隔离，减少资产间污染。
- **历史栈**：
  - `past/future` 两栈；默认仅“模型变更”入栈
  - selection、viewBox 更新不入栈（避免撤销序列被交互噪声污染）
  - 拖拽移动首次移动时记录一次快照，后续 pointermove 不再重复入栈

## 注意事项

- 当前环境里 Git Bash 的 `bash` 会报权限错误，命令执行建议直接用 PowerShell。
- 导入复杂 SVG 可能丢一部分 CSS 表现（选择器内联只支持简单形态），这是刻意的 MVP 取舍。

## 下一步行动

1. 先读 `svg_project/src/main.js`，重点看 `commit()`、`history`、wheel/keydown 的策略（需要做“输入合并”会改这里）
2. 为 A 主线先落地一项“看得见的交付”：推荐先做 **导出 sprite** + **资产重命名/删除**
3. 再补 B-lite 的第一块硬骨头：**统一 transform（scale/rotate）**，为后续手柄缩放/旋转、多选变换铺路

---
*此存档由 context-save Skill 自动生成*

